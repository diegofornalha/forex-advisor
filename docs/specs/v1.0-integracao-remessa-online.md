# Especificação: Integração Forex Advisor × Remessa Online

> Widget de análise de câmbio embeddable para o site https://www.remessaonline.com.br/

## Metadados

| Campo | Valor |
|-------|-------|
| **Versão** | 1.0.0 |
| **Tipo** | Integração/Embedding |
| **Prioridade** | Alta |
| **Escopo** | Frontend + Backend + Infra |
| **Pré-requisito** | v0.4.1 (Docs Chat com Guardrails) |
| **Complementa** | v1.0-producao.md |

## Visão Geral

Integrar o Forex Advisor como widget embeddable dentro do site da Remessa Online, permitindo que usuários acessem:
- **Chat de análise de câmbio** - Insights e perguntas sobre USD/BRL
- **Documentação interativa** - Perguntas sobre o serviço
- **Indicadores técnicos** - SMA, RSI, Bollinger Bands

### Contexto do Site Host

| Aspecto | Remessa Online |
|---------|----------------|
| **Stack** | Next.js (React) + styled-components |
| **Áreas de cotação** | `/cotacao/cotacao-dolar`, `/cotacao/cotacao-euro` |
| **Simulador** | Widget de cálculo de remessa integrado |
| **Autenticação** | Sistema próprio de login |

### Oportunidades de Integração

```
┌─────────────────────────────────────────────────────────────┐
│  REMESSA ONLINE - Áreas de Integração                       │
│                                                             │
│  1. PÁGINA DE COTAÇÃO DÓLAR (/cotacao/cotacao-dolar)       │
│     └── Widget de análise técnica + chat                   │
│                                                             │
│  2. HERO/BANNER (home)                                      │
│     └── Mini-widget com insight do dia                     │
│                                                             │
│  3. BLOG/EDUCACIONAL                                        │
│     └── Widget de documentação interativa                  │
│                                                             │
│  4. DASHBOARD PÓS-LOGIN                                     │
│     └── Widget completo com chat + indicadores             │
│                                                             │
│  5. SIDEBAR                                                 │
│     └── Mini-ticker com status do mercado                  │
└─────────────────────────────────────────────────────────────┘
```

---

## Requisitos

### Requisitos Funcionais

#### RF-01: Widget Embeddable
**Prioridade**: Alta

Widget standalone que pode ser embarcado em qualquer página via:
- **iframe** (simplicidade)
- **Web Component** (integração nativa)
- **React Component** (para sites React)

**Variantes do Widget**:

| Variante | Tamanho | Features | Uso |
|----------|---------|----------|-----|
| `mini` | 300x80px | Cotação + status | Sidebar, header |
| `compact` | 400x300px | Indicadores + mini-insight | Páginas de cotação |
| `full` | 100%x600px | Chat completo + indicadores | Dashboard, páginas dedicadas |
| `docs` | 100%x500px | Docs chat only | Blog, FAQ |

**Critérios de Aceitação**:
- [ ] Widget carrega em < 2s
- [ ] Responsivo (mobile-first)
- [ ] Tema configurável (light/dark)
- [ ] Não interfere com CSS do host
- [ ] Acessível (WCAG 2.1 AA)

---

#### RF-02: SDK de Integração
**Prioridade**: Alta

SDK JavaScript para integração simplificada.

```html
<!-- Opção 1: Script Tag (mais simples) -->
<script src="https://forex-advisor.remessaonline.com.br/widget.js"></script>
<div id="forex-widget"></div>
<script>
  ForexAdvisor.init({
    container: '#forex-widget',
    variant: 'full',
    theme: 'dark',
    apiKey: 'ro_live_xxx',  // Opcional: para tracking
    locale: 'pt-BR',
  });
</script>

<!-- Opção 2: iframe (isolamento total) -->
<iframe
  src="https://forex-advisor.remessaonline.com.br/embed?variant=compact&theme=dark"
  width="400"
  height="300"
  frameborder="0"
  allow="clipboard-write"
></iframe>

<!-- Opção 3: Web Component -->
<forex-advisor-widget
  variant="full"
  theme="dark"
  api-key="ro_live_xxx"
></forex-advisor-widget>
```

**Critérios de Aceitação**:
- [ ] SDK < 50KB gzipped
- [ ] Zero dependências externas
- [ ] TypeScript types incluídos
- [ ] Documentação de integração
- [ ] Exemplos para React, Vue, vanilla JS

---

#### RF-03: API Gateway / Proxy
**Prioridade**: Alta

Endpoint dedicado para o site da Remessa Online com:
- CORS configurado para `*.remessaonline.com.br`
- Rate limiting por API key
- Métricas de uso por cliente

```
┌─────────────────────────────────────────────────────────────┐
│  FLUXO DE REQUISIÇÃO                                        │
│                                                             │
│  Browser (remessaonline.com.br)                            │
│       │                                                     │
│       │ API Key: ro_live_xxx                               │
│       ▼                                                     │
│  ┌─────────────────┐                                        │
│  │  API Gateway    │  (nginx ou CloudFlare)                │
│  │  - CORS         │                                        │
│  │  - Rate Limit   │                                        │
│  │  - Auth         │                                        │
│  └────────┬────────┘                                        │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │  Forex Advisor  │                                        │
│  │  Backend        │                                        │
│  │  (FastAPI)      │                                        │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
```

**Critérios de Aceitação**:
- [ ] CORS: `*.remessaonline.com.br`, `localhost:*` (dev)
- [ ] API Keys: geração, rotação, revogação
- [ ] Rate Limit: 1000 req/min por API key
- [ ] Métricas: requests por key, latência, erros
- [ ] Logs: audit trail de uso

---

#### RF-04: Histórico de Conversas por Usuário
**Prioridade**: Alta (v1.0)

Persistir histórico de conversas vinculado ao ID do usuário da Remessa Online.

**Modelo de Dados**:

```python
# app/models.py

class UserChatHistory(BaseModel):
    """Histórico de chat vinculado a usuário"""
    user_id: str              # ID do usuário na Remessa Online
    session_id: str           # UUID da sessão de chat
    messages: list[Message]   # Histórico de mensagens
    created_at: datetime
    last_activity: datetime
    metadata: dict = {}       # Info adicional (device, source, etc)

class UserPreferences(BaseModel):
    """Preferências do usuário"""
    user_id: str
    theme: str = "dark"
    notifications: bool = True
    favorite_pairs: list[str] = ["USDBRL"]
```

**Storage**:

```
┌─────────────────────────────────────────────────────────────┐
│  STORAGE DE HISTÓRICO                                       │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   Redis     │    │  PostgreSQL │    │    S3       │     │
│  │  (sessões   │    │  (histórico │    │  (backups   │     │
│  │   ativas)   │    │   completo) │    │   e export) │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│                                                             │
│  Fluxo:                                                     │
│  1. Sessão ativa → Redis (TTL 24h)                         │
│  2. Sessão encerrada → PostgreSQL (permanente)             │
│  3. Export/backup → S3 (sob demanda)                       │
└─────────────────────────────────────────────────────────────┘
```

**API de Histórico**:

```
GET  /api/v1/users/{user_id}/chat/history
     → Lista todas as sessões do usuário

GET  /api/v1/users/{user_id}/chat/sessions/{session_id}
     → Retorna sessão específica com mensagens

POST /api/v1/users/{user_id}/chat/sessions
     → Cria nova sessão vinculada ao usuário

DELETE /api/v1/users/{user_id}/chat/sessions/{session_id}
     → Remove sessão (soft delete)

GET  /api/v1/users/{user_id}/chat/export
     → Exporta histórico completo (PDF/JSON)
```

**Critérios de Aceitação**:
- [ ] Histórico persistido por user_id
- [ ] Recuperação de sessões anteriores
- [ ] Limite de histórico por tier (free: 7 dias, premium: 90 dias)
- [ ] Export de histórico (JSON, PDF)
- [ ] LGPD: endpoint para deletar dados do usuário

---

#### RF-05: Autenticação e SSO
**Prioridade**: Média

Suporte a usuários autenticados da Remessa Online para features premium.

**Fluxo SSO (Single Sign-On)**:

```
┌─────────────────────────────────────────────────────────────┐
│  FLUXO DE AUTENTICAÇÃO                                      │
│                                                             │
│  1. Usuário logado na Remessa Online                       │
│  2. Site gera token JWT temporário para o widget           │
│  3. Widget recebe token via postMessage ou SDK init        │
│  4. Widget envia token no header Authorization             │
│  5. Backend valida token com Remessa Online                │
│  6. Features premium habilitadas                           │
└─────────────────────────────────────────────────────────────┘
```

**Features por Tier**:

| Feature | Anônimo | Free | Premium |
|---------|---------|------|---------|
| Ver cotação atual | ✅ | ✅ | ✅ |
| Indicadores básicos | ✅ | ✅ | ✅ |
| Chat (5 msg/dia) | ✅ | ❌ | ❌ |
| Chat (50 msg/dia) | ❌ | ✅ | ❌ |
| Chat ilimitado | ❌ | ❌ | ✅ |
| Histórico (sessão) | ✅ | ✅ | ✅ |
| Histórico (7 dias) | ❌ | ✅ | ✅ |
| Histórico (90 dias) | ❌ | ❌ | ✅ |
| Retomar conversa | ❌ | ✅ | ✅ |
| Export histórico | ❌ | ❌ | ✅ |
| Alertas personalizados | ❌ | ❌ | ✅ |

**Critérios de Aceitação**:
- [ ] Widget funciona sem autenticação (modo anônimo)
- [ ] Suporte a JWT da Remessa Online
- [ ] Rate limit diferenciado por tier
- [ ] Graceful degradation se auth falhar

---

#### RF-05: Comunicação Widget ↔ Host
**Prioridade**: Média

API de eventos para comunicação entre widget e site host.

```javascript
// Host → Widget
ForexAdvisor.setTheme('dark');
ForexAdvisor.setUser({ id: '123', tier: 'premium' });
ForexAdvisor.open();  // Expande widget
ForexAdvisor.close(); // Minimiza widget

// Widget → Host (eventos)
ForexAdvisor.on('ready', () => console.log('Widget loaded'));
ForexAdvisor.on('message', (msg) => console.log('User sent:', msg));
ForexAdvisor.on('insight', (data) => {
  // Pode usar para atualizar UI do host
  console.log('New insight:', data.classification);
});
ForexAdvisor.on('error', (err) => console.error('Widget error:', err));
```

**Critérios de Aceitação**:
- [ ] postMessage API para iframes
- [ ] Custom Events para Web Components
- [ ] Callback API para SDK
- [ ] Documentação de eventos

---

### Requisitos Não Funcionais

#### RNF-01: Performance
- Widget carrega em < 2s (LCP)
- TTI (Time to Interactive) < 3s
- Bundle size < 100KB gzipped (SDK + Widget)
- Lazy loading de features pesadas (chat)

#### RNF-02: Segurança
- CSP (Content Security Policy) compatível
- Sanitização de inputs
- Sem cookies de terceiros
- HTTPS obrigatório

#### RNF-03: Isolamento
- CSS não vaza para o host (shadow DOM ou iframe)
- JS não polui namespace global
- Não interfere com analytics do host

#### RNF-04: Acessibilidade
- WCAG 2.1 AA compliance
- Navegação por teclado
- Screen reader friendly
- Alto contraste disponível

---

## Abordagem Técnica

### Arquitetura de Integração

```
┌─────────────────────────────────────────────────────────────────────┐
│  ARQUITETURA WIDGET EMBEDDABLE                                       │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  CDN (CloudFlare/Vercel)                                      │  │
│  │  ├── widget.js (SDK)                                          │  │
│  │  ├── widget.css                                               │  │
│  │  └── /embed/* (páginas do widget)                             │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  API Gateway                                                   │  │
│  │  ├── api.forex-advisor.remessaonline.com.br                  │  │
│  │  ├── CORS: *.remessaonline.com.br                            │  │
│  │  ├── Auth: API Key + JWT                                      │  │
│  │  └── Rate Limit: 1000 req/min                                 │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│                              ▼                                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Backend (FastAPI)                                            │  │
│  │  ├── /api/v1/forex/* (REST)                                  │  │
│  │  ├── /ws/chat/* (WebSocket)                                  │  │
│  │  ├── /ws/docs/* (WebSocket)                                  │  │
│  │  └── /embed/* (Widget pages)                                 │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Opções de Integração

| Opção | Prós | Contras | Recomendado |
|-------|------|---------|-------------|
| **iframe** | Isolamento total, simples | Comunicação limitada, SEO ruim | Para embed rápido |
| **Web Component** | Nativo, encapsulado | Suporte browser, complexidade | Para integração profunda |
| **React Package** | Tipado, integração nativa | Só para React, bundle maior | Para sites React |
| **SDK + div** | Flexível, qualquer framework | Pode conflitar CSS | Padrão recomendado |

**Recomendação**: Oferecer todas as opções, começar por **iframe** (mais simples) e **SDK** (mais flexível).

### Estrutura de Arquivos

```
forex-advisor/
├── app/
│   ├── embed/                    [CRIAR]
│   │   ├── __init__.py
│   │   ├── routes.py             # Páginas do widget
│   │   ├── auth.py               # API key + JWT validation
│   │   └── cors.py               # CORS config
│   └── main.py                   [MODIFICAR - adicionar embed routes]
│
├── widget/                       [CRIAR]
│   ├── src/
│   │   ├── index.ts              # Entry point SDK
│   │   ├── ForexAdvisor.ts       # Classe principal
│   │   ├── Widget.tsx            # React component
│   │   ├── WebComponent.ts       # Custom Element
│   │   ├── iframe.ts             # iframe helper
│   │   ├── events.ts             # Event system
│   │   └── types.ts              # TypeScript types
│   ├── styles/
│   │   └── widget.css            # Estilos isolados
│   ├── package.json
│   ├── tsconfig.json
│   ├── rollup.config.js          # Build config
│   └── README.md                 # Docs de integração
│
├── forex-advisor-front/prototipo/
│   ├── src/
│   │   ├── embed/                [CRIAR]
│   │   │   ├── EmbedApp.tsx      # App wrapper para embed
│   │   │   ├── variants/
│   │   │   │   ├── MiniWidget.tsx
│   │   │   │   ├── CompactWidget.tsx
│   │   │   │   └── FullWidget.tsx
│   │   │   └── embed-main.tsx    # Entry point embed
│   │   └── App.tsx               [MODIFICAR - routing]
│   └── vite.config.ts            [MODIFICAR - build embed]
│
└── docs/
    └── INTEGRATION.md            [CRIAR - guia de integração]
```

---

## Fases de Implementação

### Fase 1: Backend - Embed Routes + CORS
**Objetivo**: Preparar backend para servir o widget

**Tarefas**:
- [ ] 1.1 Criar `app/embed/` module
- [ ] 1.2 Implementar API key system (geração, validação)
- [ ] 1.3 Configurar CORS dinâmico por API key
- [ ] 1.4 Criar rotas `/embed/mini`, `/embed/compact`, `/embed/full`
- [ ] 1.5 Adicionar métricas por API key
- [ ] 1.6 Testes de CORS e auth
- [ ] 1.7 Commit: "feat: embed backend infrastructure"

---

### Fase 2: Frontend - Variantes do Widget
**Objetivo**: Criar componentes do widget em diferentes tamanhos

**Tarefas**:
- [ ] 2.1 Criar estrutura `src/embed/`
- [ ] 2.2 Implementar `MiniWidget` (cotação + status)
- [ ] 2.3 Implementar `CompactWidget` (indicadores + insight)
- [ ] 2.4 Implementar `FullWidget` (chat completo)
- [ ] 2.5 Criar `EmbedApp` com routing por variante
- [ ] 2.6 Configurar build separado para embed
- [ ] 2.7 Testar responsividade
- [ ] 2.8 Commit: "feat: widget variants (mini, compact, full)"

---

### Fase 3: SDK JavaScript
**Objetivo**: Criar SDK para integração fácil

**Tarefas**:
- [ ] 3.1 Criar projeto `widget/` com Rollup
- [ ] 3.2 Implementar `ForexAdvisor` class
- [ ] 3.3 Implementar sistema de eventos
- [ ] 3.4 Criar Web Component wrapper
- [ ] 3.5 Build UMD + ESM
- [ ] 3.6 TypeScript definitions
- [ ] 3.7 Minificar e otimizar (< 50KB)
- [ ] 3.8 Commit: "feat: javascript sdk for widget integration"

---

### Fase 4: Comunicação Widget ↔ Host
**Objetivo**: API de eventos bidirecional

**Tarefas**:
- [ ] 4.1 Implementar postMessage para iframes
- [ ] 4.2 Implementar CustomEvents para Web Components
- [ ] 4.3 Callbacks para SDK
- [ ] 4.4 Eventos: ready, message, insight, error
- [ ] 4.5 Métodos: setTheme, setUser, open, close
- [ ] 4.6 Testes de comunicação
- [ ] 4.7 Commit: "feat: widget-host communication api"

---

### Fase 5: Histórico de Conversas por Usuário
**Objetivo**: Persistir histórico vinculado ao user_id

**Tarefas**:
- [ ] 5.1 Criar modelos `UserChatHistory`, `UserPreferences`
- [ ] 5.2 Implementar storage: Redis (ativo) + PostgreSQL (histórico)
- [ ] 5.3 Criar endpoints `/api/v1/users/{user_id}/chat/*`
- [ ] 5.4 Migração de sessões anônimas para user_id
- [ ] 5.5 Implementar TTL por tier (7 dias free, 90 dias premium)
- [ ] 5.6 Export de histórico (JSON, PDF)
- [ ] 5.7 Endpoint LGPD para deletar dados
- [ ] 5.8 Testes de persistência
- [ ] 5.9 Commit: "feat: user chat history persistence"

---

### Fase 6: Autenticação SSO
**Objetivo**: Integrar com auth da Remessa Online

**Tarefas**:
- [ ] 6.1 Definir contrato JWT com Remessa Online
- [ ] 6.2 Implementar validação de token no backend
- [ ] 6.3 Rate limiting diferenciado por tier
- [ ] 6.4 Graceful degradation
- [ ] 6.5 Testes de auth
- [ ] 6.6 Commit: "feat: sso authentication for premium features"

---

### Fase 7: Documentação e Exemplos
**Objetivo**: Guia completo de integração

**Tarefas**:
- [ ] 7.1 Criar `INTEGRATION.md` com guia passo a passo
- [ ] 7.2 Exemplos: React, Vue, Next.js, vanilla JS
- [ ] 7.3 Storybook com variantes
- [ ] 7.4 Playground interativo
- [ ] 7.5 Troubleshooting comum
- [ ] 7.6 Commit: "docs: integration guide and examples"

---

### Fase 8: Deploy e CDN
**Objetivo**: Infraestrutura de produção

**Tarefas**:
- [ ] 8.1 Configurar subdomínio `forex-advisor.remessaonline.com.br`
- [ ] 8.2 Deploy widget em CDN (CloudFlare/Vercel)
- [ ] 8.3 Configurar cache headers
- [ ] 8.4 SSL/TLS
- [ ] 8.5 Monitoramento de disponibilidade
- [ ] 8.6 Commit: "infra: production deployment"

---

## Dependências

### Internas
- v0.4.1 com Docs Chat funcionando
- v1.0-producao.md (métricas, CI/CD)

### Externas
- Subdomínio da Remessa Online
- Acesso ao DNS/CDN
- Contrato de API key com time da Remessa Online
- Especificação JWT para SSO

### Bloqueios

| Bloqueio | Impacto | Mitigação |
|----------|---------|-----------|
| Subdomínio não disponível | Deploy | Usar domínio próprio temporário |
| JWT spec indefinida | SSO | Começar sem auth, adicionar depois |
| CORS restrito no host | Widget | Usar iframe como fallback |

---

## Riscos e Mitigações

| Risco | Probabilidade | Impacto | Mitigação |
|-------|---------------|---------|-----------|
| Widget quebra CSS do host | Média | Alto | Shadow DOM, iframe |
| Latência alta no embed | Baixa | Médio | CDN, lazy loading |
| API key vazada | Baixa | Alto | Rate limit, rotação, IP allowlist |
| SSO complexo demais | Média | Médio | Começar sem auth |
| Bundle muito grande | Média | Médio | Code splitting, lazy load |

---

## Critérios de Sucesso

### Técnicos
- [ ] Widget carrega em < 2s
- [ ] SDK < 50KB gzipped
- [ ] Zero conflitos CSS com host
- [ ] 99.9% uptime do CDN

### Produto
- [ ] Todas variantes funcionando
- [ ] Integração com 1 página da Remessa Online
- [ ] Documentação aprovada pelo time

### Negócio
- [ ] X usuários interagindo com widget/dia
- [ ] Y mensagens no chat/dia
- [ ] Feedback positivo do time da Remessa Online

---

## Referências

- [Roadmap Completo](../ROADMAP.md)
- [v1.0-producao.md](v1.0-producao.md)
- [Web Components MDN](https://developer.mozilla.org/en-US/docs/Web/API/Web_components)
- [postMessage API](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)
- [Shadow DOM](https://developer.mozilla.org/en-US/docs/Web/API/Web_components/Using_shadow_DOM)

---

## Histórico

| Data | Versão | Autor | Mudanças |
|------|--------|-------|----------|
| 2026-01-23 | 1.0 | Claude | Criação inicial |
